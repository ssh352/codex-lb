{
  "uid": "codex-lb",
  "title": "codex-lb",
  "timezone": "browser",
  "schemaVersion": 39,
		  "version": 25,
  "refresh": "1m",
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "5s",
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "1h"
    ],
    "time_options": [
      "5m",
      "15m",
      "1h",
      "6h",
      "12h",
      "24h",
      "7d",
      "30d"
    ]
  },
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      },
      {
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": false,
        "iconColor": "rgba(56, 189, 248, 0.85)",
        "name": "Day boundary (00:00)",
        "type": "dashboard",
        "target": {
          "queryType": "timeRegions",
          "timeRegion": {
            "from": "00:00",
            "to": "00:05",
            "timezone": "browser"
          }
        }
      }
    ]
  },
  "templating": {
    "list": [
      {
        "name": "model",
        "type": "query",
        "label": "Model",
        "datasource": "Prometheus",
        "query": "label_values(codex_lb_proxy_requests_total, model)",
        "multi": true,
        "includeAll": true,
        "allValue": ".*",
        "current": {
          "text": "All",
          "value": ".*"
        }
      },
      {
        "name": "api",
        "type": "query",
        "label": "API",
        "datasource": "Prometheus",
        "query": "label_values(codex_lb_proxy_requests_total, api)",
        "multi": true,
        "includeAll": true,
        "allValue": ".*",
        "current": {
          "text": "All",
          "value": ".*"
        }
      },
	      {
	        "name": "account",
	        "type": "query",
	        "label": "Account",
	        "datasource": "Prometheus",
	        "query": "query_result(codex_lb_account_identity or on(account_id) label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\"))",
	        "regex": "account_id=\"(?<value>[^\"]+)\".*display=\"(?<text>[^\"]+)\"",
	        "multi": true,
	        "includeAll": true,
	        "allValue": ".*",
	        "current": {
	          "text": "All",
	          "value": ".*"
	        }
	      },
	      {
	        "name": "accounts_top_n",
	        "type": "custom",
	        "label": "Top N accounts (tables)",
	        "description": "Used by leaderboard tables (yesterday + 30d totals). Set to 10000 to effectively show all accounts with activity in the time window.",
	        "query": "20,50,100,200,10000",
	        "current": {
	          "text": "20",
	          "value": "20"
	        }
	      },
	      {
	        "name": "accounts_top_n_realtime",
	        "type": "custom",
	        "label": "Top N accounts (realtime charts)",
	        "description": "Used by realtime timeseries charts (cost/hr, requests/min). Keep small; large values make charts unreadable and heavier to render.",
	        "query": "5,10,20,50,100,200",
	        "current": {
	          "text": "10",
	          "value": "10"
	        }
	      },
			      {
			        "name": "secondary_quota_min_pp",
			        "type": "custom",
			        "label": "Min secondary used (pp)",
			        "query": "20,30,40,50",
		        "current": {
		          "text": "20",
		          "value": "20"
		        }
		      }
	    ]
	  },
  "panels": [
    {
      "id": 1,
      "type": "timeseries",
      "title": "Cost/hr (USD, total)",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 12,
        "h": 8
      },
      "targets": [
        {
          "refId": "A",
	          "expr": "sum(rate(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[1h])) * 3600"
        }
      ]
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "Cost/hr by model (USD, stacked)",
      "gridPos": {
        "x": 12,
        "y": 0,
        "w": 12,
        "h": 8
      },
      "targets": [
        {
          "refId": "A",
	          "expr": "sum by (model) (rate(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[1h])) * 3600"
        }
      ]
    },
    {
      "id": 3,
      "type": "timeseries",
      "title": "Tokens/min by kind (total)",
      "gridPos": {
        "x": 0,
        "y": 8,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
	          "expr": "sum by (kind) (rate(codex_lb_proxy_tokens_total{model=~\"$model\"}[1h])) * 60"
        }
      ]
    },
    {
      "id": 4,
      "type": "timeseries",
      "title": "Cache hit % (input tokens, 1h buckets)",
      "gridPos": {
        "x": 12,
        "y": 8,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
	          "expr": "100 * sum(increase(codex_lb_proxy_tokens_total{kind=\"cached_input\",model=~\"$model\"}[1h])) / clamp_min(sum(increase(codex_lb_proxy_tokens_total{kind=\"input\",model=~\"$model\"}[1h])), 1)",
          "interval": "1h"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "min": 0,
          "max": 100,
          "unit": "percent"
        },
        "overrides": []
      }
    },
    {
      "id": 5,
      "type": "timeseries",
      "title": "Requests/min by model",
      "gridPos": {
        "x": 0,
        "y": 15,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
	          "expr": "sum by (model) (rate(codex_lb_proxy_requests_total{model=~\"$model\",api=~\"$api\"}[1h])) * 60"
        }
      ]
    },
	    {
	      "id": 6,
	      "type": "timeseries",
	      "title": "Error rate",
	      "description": "Overall proxy error rate as a percentage over the selected interval (lookback: 1h). Computed as: 100 * sum rate(codex_lb_proxy_requests_total{status=\"error\"}) / sum rate(codex_lb_proxy_requests_total). 0% means no errors; 100% means all requests errored.",
	      "gridPos": {
	        "x": 12,
	        "y": 15,
	        "w": 12,
	        "h": 7
	      },
	      "targets": [
	        {
	          "refId": "A",
		          "expr": "100 * (sum(rate(codex_lb_proxy_requests_total{status=\"error\",model=~\"$model\",api=~\"$api\"}[1h])) / sum(rate(codex_lb_proxy_requests_total{model=~\"$model\",api=~\"$api\"}[1h])))"
	        }
	      ],
	      "fieldConfig": {
	        "defaults": {
	          "min": 0,
	          "max": 100,
	          "unit": "percent"
	        },
	        "overrides": []
	      }
	    },
	    {
	      "id": 7,
	      "type": "timeseries",
	      "title": "Latency p50/p95 (global, s)",
		"description": "Server-side proxy round-trip time per attempt (codex-lb -> upstream -> codex-lb), derived from codex_lb_proxy_latency_ms_bucket (ms->s). For streaming APIs, this measures total stream duration until completion/failure (not time-to-first-token). Excludes client->codex-lb network/UI time. Retries/failovers contribute separate samples. PromQL: histogram_quantile over sum by (le) of rate(...[1h]) across selected model/api. p50=median; p95=tail (95% of attempts are faster).",
	      "gridPos": {
	        "x": 0,
	        "y": 22,
	        "w": 12,
	        "h": 7
	      },
	      "targets": [
	        {
	          "refId": "A",
		          "expr": "histogram_quantile(0.5, sum by (le) (rate(codex_lb_proxy_latency_ms_bucket{model=~\"$model\",api=~\"$api\"}[1h]))) / 1000",
	          "legendFormat": "p50"
	        },
	        {
	          "refId": "B",
		          "expr": "histogram_quantile(0.95, sum by (le) (rate(codex_lb_proxy_latency_ms_bucket{model=~\"$model\",api=~\"$api\"}[1h]))) / 1000",
	          "legendFormat": "p95"
	        }
	      ],
	      "fieldConfig": {
	        "defaults": {
	          "unit": "s"
	        },
	        "overrides": []
	      },
	      "options": {
	        "legend": {
	          "calcs": [],
	          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      }
    },
    {
      "id": 8,
      "type": "timeseries",
      "title": "Cost/request (avg, USD)",
      "gridPos": {
        "x": 12,
        "y": 22,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
	          "expr": "sum(rate(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[1h])) / sum(rate(codex_lb_proxy_requests_total{model=~\"$model\",api=~\"$api\"}[1h]))"
        }
      ]
    },
	    {
	      "id": 9,
	      "type": "timeseries",
	      "title": "Latency p95 by model (s)",
		"description": "Per-model p95 (tail) server-side proxy round-trip time per attempt (codex-lb -> upstream -> codex-lb), from codex_lb_proxy_latency_ms_bucket (ms->s). For streaming APIs, this is total stream duration until completion/failure (not time-to-first-token). Excludes client->codex-lb time; retries/failovers are separate samples. PromQL: histogram_quantile over sum by (model, le) of rate(...[1h]) for selected model/api.",
	      "gridPos": {
	        "x": 0,
	        "y": 29,
	        "w": 12,
	        "h": 8
	      },
	      "targets": [
	        {
	          "refId": "A",
		          "expr": "histogram_quantile(0.95, sum by (model, le) (rate(codex_lb_proxy_latency_ms_bucket{model=~\"$model\",api=~\"$api\"}[1h]))) / 1000",
	          "legendFormat": "{{model}}"
	        }
	      ],
	      "fieldConfig": {
	        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "orange",
                "value": 1
              },
              {
                "color": "red",
                "value": 2
              }
            ]
          },
          "unit": "s"
        },
        "overrides": []
      },
	      "options": {
	        "legend": {
	          "calcs": [],
	          "displayMode": "list",
	          "placement": "bottom",
	          "showLegend": true
	        },
	        "tooltip": {
	          "mode": "single",
	          "sort": "none"
	        }
	      }
	    },
	    {
	      "id": 10,
	      "type": "timeseries",
	      "title": "Top 10 error codes",
	      "gridPos": {
	        "x": 12,
	        "y": 52,
	        "w": 12,
	        "h": 7
	      },
	      "targets": [
	        {
	          "refId": "A",
          "expr": "topk(10, sum by (error_code) (rate(codex_lb_proxy_errors_total[1h])))",
          "legendFormat": "{{error_code}}"
        }
      ]
    },
    {
      "id": 15,
      "type": "timeseries",
	      "title": "Top $accounts_top_n_realtime accounts by cost/hr",
      "gridPos": {
        "x": 0,
        "y": 37,
        "w": 12,
        "h": 8
      },
      "targets": [
	        {
	          "refId": "A",
	          "expr": "label_replace(topk($accounts_top_n_realtime, sum by (account_id) (rate(codex_lb_proxy_account_cost_usd_total{account_id=~\"$account\",api=~\"$api\"}[1h])) * 3600) * on(account_id) group_left(display) ((codex_lb_account_identity @ end()) or on(account_id) label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\")), \"account_id\", \"$1\", \"display\", \"(.*)\")",
          "legendFormat": "{{display}}"
        }
      ]
    },
    {
      "id": 16,
      "type": "timeseries",
	      "title": "Top $accounts_top_n_realtime accounts by requests/min",
      "gridPos": {
        "x": 12,
        "y": 37,
        "w": 12,
        "h": 8
      },
      "targets": [
	        {
	          "refId": "A",
	          "expr": "label_replace(topk($accounts_top_n_realtime, sum by (account_id) (rate(codex_lb_proxy_account_requests_total{account_id=~\"$account\",api=~\"$api\"}[1h])) * 60) * on(account_id) group_left(display) ((codex_lb_account_identity @ end()) or on(account_id) label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\")), \"account_id\", \"$1\", \"display\", \"(.*)\")",
          "legendFormat": "{{display}}"
        }
      ]
    },
		    {
		      "id": 17,
		      "type": "timeseries",
		      "title": "Error rate by account (Top 10, %)",
		      "description": "Per-account proxy error rate as a percentage over the selected interval (lookback: 1h). Computed as: 100 * (sum by (account_id) rate(codex_lb_proxy_account_requests_total{status=\"error\"}) / sum by (account_id) rate(codex_lb_proxy_account_requests_total)). Example: 2.5 means 2.5% of that account’s requests errored. PromQL: topk(10, percent_error) joined with codex_lb_account_identity for a human-friendly display label.",
		      "gridPos": {
		        "x": 0,
		        "y": 45,
		        "w": 12,
		        "h": 7
		      },
		      "targets": [
			        {
			          "refId": "A",
	          "expr": "label_replace(topk(10, 100 * (sum by (account_id) (rate(codex_lb_proxy_account_requests_total{status=\"error\",account_id=~\"$account\",api=~\"$api\"}[1h])) / sum by (account_id) (rate(codex_lb_proxy_account_requests_total{account_id=~\"$account\",api=~\"$api\"}[1h])))) * on(account_id) group_left(display) ((codex_lb_account_identity @ end()) or on(account_id) label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\")), \"account_id\", \"$1\", \"display\", \"(.*)\")",
	          "legendFormat": "{{display}}"
	        }
		      ],
		      "fieldConfig": {
		        "defaults": {
		          "min": 0,
		          "max": 100,
	          "unit": "percent"
		        },
		        "overrides": []
		      }
		    },
    {
      "id": 18,
      "type": "timeseries",
      "title": "Routing: selections/min by outcome",
      "gridPos": {
        "x": 12,
        "y": 45,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (pool, outcome) (rate(codex_lb_lb_select_total[1h])) * 60"
        }
      ]
    },
    {
      "id": 19,
      "type": "timeseries",
      "title": "Routing: mark events/min",
      "description": "How often the load balancer \"marks\" an account due to upstream signals. A mark is a state update on a specific account (e.g., set/extend cooldown until reset, mark quota exceeded, record a permanent failure code, or record an error) so routing can avoid/select it appropriately. This panel plots sum by (event) of rate(codex_lb_lb_mark_total{event,account_id}) and converts to per-minute. event: rate_limit (includes usage_limit_reached), quota_exceeded, permanent_failure, error.",
      "gridPos": {
        "x": 0,
        "y": 52,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (event) (rate(codex_lb_lb_mark_total[1h])) * 60"
        }
      ]
    },
	    {
	      "id": 20,
	      "type": "timeseries",
	      "title": "Latency p50 by model (s)",
		"description": "Per-model p50 (median) server-side proxy round-trip time per attempt (codex-lb -> upstream -> codex-lb), from codex_lb_proxy_latency_ms_bucket (ms->s). For streaming APIs, this is total stream duration until completion/failure (not time-to-first-token). Excludes client->codex-lb time; retries/failovers are separate samples. PromQL: histogram_quantile over sum by (model, le) of rate(...[1h]) for selected model/api.",
	      "gridPos": {
	        "x": 12,
	        "y": 29,
	        "w": 12,
	        "h": 8
	      },
	      "targets": [
	        {
	          "refId": "A",
		          "expr": "histogram_quantile(0.5, sum by (model, le) (rate(codex_lb_proxy_latency_ms_bucket{model=~\"$model\",api=~\"$api\"}[1h]))) / 1000",
	          "legendFormat": "{{model}}"
	        }
	      ],
	      "fieldConfig": {
	        "defaults": {
          "unit": "s"
        },
        "overrides": []
      },
	      "options": {
	        "legend": {
	          "calcs": [],
	          "displayMode": "list",
	          "placement": "bottom",
	          "showLegend": true
	        },
	        "tooltip": {
	          "mode": "single",
	          "sort": "none"
	        }
	      }
	    },
    {
      "id": 21,
      "type": "timeseries",
      "title": "Cost/hr by account (selected)",
      "gridPos": {
        "x": 0,
        "y": 59,
        "w": 12,
        "h": 7
      },
      "targets": [
	        {
	          "refId": "A",
	          "expr": "label_replace((sum by (account_id) (rate(codex_lb_proxy_account_cost_usd_total{account_id=~\"$account\",api=~\"$api\"}[1h])) * 3600) * on(account_id) group_left(display) ((codex_lb_account_identity @ end()) or on(account_id) label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\")), \"account_id\", \"$1\", \"display\", \"(.*)\")",
          "legendFormat": "{{display}}"
        }
      ]
    },
    {
      "id": 22,
      "type": "timeseries",
      "title": "Requests/min by account (selected)",
      "gridPos": {
        "x": 12,
        "y": 59,
        "w": 12,
        "h": 7
      },
      "targets": [
	        {
	          "refId": "A",
	          "expr": "label_replace((sum by (account_id) (rate(codex_lb_proxy_account_requests_total{account_id=~\"$account\",api=~\"$api\"}[1h])) * 60) * on(account_id) group_left(display) ((codex_lb_account_identity @ end()) or on(account_id) label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\")), \"account_id\", \"$1\", \"display\", \"(.*)\")",
          "legendFormat": "{{display}}"
        }
      ]
    },
    {
      "id": 36,
      "type": "timeseries",
      "title": "Usage refresh failures/min (status + phase)",
      "description": "Background usage polling failures. phase=initial_fetch is first attempt; phase=post_refresh_retry is retry after 401-triggered token refresh.",
      "gridPos": {
        "x": 0,
        "y": 66,
        "w": 24,
        "h": 8
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (status_code, phase) (rate(codex_lb_usage_refresh_failures_total[$__rate_interval])) * 60",
          "legendFormat": "{{status_code}} {{phase}}"
        }
      ]
    },
    {
      "id": 25,
      "type": "timeseries",
      "title": "Retries/min (by error class)",
      "gridPos": {
        "x": 0,
        "y": 74,
        "w": 12,
        "h": 7
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (error_class) (rate(codex_lb_proxy_retries_total{api=~\"$api\"}[1h])) * 60"
        }
      ]
    },
				    {
				      "id": 26,
				      "type": "table",
				      "title": "Estimated Weekly Quota (USD, 7d)",
						      "description": "Rolling per-account estimate from SQLite. Quota ≈ Spend / (used_pp/100), where Spend is proxy cost from request_logs and used_pp is the latest secondary usage_history.used_percent for the current weekly cycle (clamped to [0,100]); both are clipped to the last 7 days. Use $secondary_quota_min_pp to suppress thin-signal accounts. Note: the PromQL wraps the label_join() input in extra parentheses for readability only (no semantic change).",
					      "gridPos": {
					        "x": 12,
					        "y": 74,
					        "w": 12,
				        "h": 7
				      },
			      "fieldConfig": {
			        "defaults": {
			          "color": {
			            "mode": "thresholds"
			          },
			          "custom": {
			            "align": "auto",
			            "cellOptions": {
			              "type": "auto"
			            },
			            "inspect": false
			          },
			          "mappings": [],
			          "thresholds": {
			            "mode": "absolute",
			            "steps": [
			              {
			                "color": "green",
			                "value": null
			              },
			              {
			                "color": "red",
			                "value": 1
			              }
			            ]
			          }
			        },
			        "overrides": [
			          {
			            "matcher": {
			              "id": "byName",
			              "options": "account_display"
			            },
			            "properties": [
			              {
			                "id": "displayName",
			                "value": "Account"
			              },
			              {
			                "id": "custom.cellOptions",
			                "value": {
			                  "type": "color-text"
			                }
			              },
			              {
			                "id": "mappings",
			                "value": [
			                  {
			                    "type": "regex",
			                    "options": {
			                      "pattern": "^free::(.*)$",
			                      "result": {
			                        "text": "$1 (free)",
			                        "color": "#71717a"
			                      }
			                    }
			                  },
			                  {
			                    "type": "regex",
			                    "options": {
			                      "pattern": "^plus::(.*)$",
			                      "result": {
			                        "text": "$1 (plus)",
			                        "color": "#1d4ed8"
			                      }
			                    }
			                  },
			                  {
			                    "type": "regex",
			                    "options": {
			                      "pattern": "^pro::(.*)$",
			                      "result": {
			                        "text": "$1 (pro)",
			                        "color": "#6d28d9"
			                      }
			                    }
			                  },
			                  {
			                    "type": "regex",
			                    "options": {
			                      "pattern": "^[^:]+::(.*)$",
			                      "result": {
			                        "text": "$1",
			                        "color": "#71717a"
			                      }
			                    }
			                  }
			                ]
			              }
			            ]
			          },
			          {
			            "matcher": {
			              "id": "byName",
			              "options": "Quota (USD, 7d)"
			            },
			            "properties": [
			              {
			                "id": "unit",
			                "value": "currencyUSD"
			              },
			              {
			                "id": "decimals",
			                "value": 0
			              },
			              {
			                "id": "color",
			                "value": {
			                  "mode": "continuous-GrYlRd"
			                }
			              },
			              {
			                "id": "custom.cellOptions",
			                "value": {
			                  "type": "gauge",
			                  "mode": "gradient"
			                }
			              },
			              {
			                "id": "displayName",
			                "value": "Quota (USD, 7d)"
			              }
			            ]
			          },
				          {
				            "matcher": {
				              "id": "byName",
				              "options": "Spend (USD, since reset)"
				            },
				            "properties": [
				              {
				                "id": "displayName",
				                "value": "Spend (USD, since reset)"
				              },
			              {
			                "id": "unit",
			                "value": "currencyUSD"
			              },
			              {
			                "id": "decimals",
			                "value": 0
			              },
			              {
			                "id": "custom.cellOptions",
			                "value": {
			                  "type": "auto"
			                }
			              }
			            ]
			          },
					          {
					            "matcher": {
					              "id": "byName",
					              "options": "Δpp (since reset)"
					            },
					            "properties": [
					              {
					                "id": "displayName",
					                "value": "Used (pp, since reset)"
					              },
					              {
					                "id": "unit",
					                "value": "suffix:pp"
					              },
			              {
			                "id": "decimals",
			                "value": 0
			              },
			              {
			                "id": "custom.cellOptions",
			                "value": {
			                  "type": "auto"
			                }
			              }
			            ]
			          },
			          {
			            "matcher": {
			              "id": "byName",
			              "options": "Time"
			            },
			            "properties": [
			              {
			                "id": "custom.hideFrom",
			                "value": {
			                  "viz": true,
			                  "legend": true,
			                  "tooltip": true
			                }
			              }
			            ]
			          },
			          {
			            "matcher": {
			              "id": "byName",
			              "options": "account_id"
			            },
			            "properties": [
			              {
			                "id": "custom.hideFrom",
			                "value": {
			                  "viz": true,
			                  "legend": true,
			                  "tooltip": true
			                }
			              }
			            ]
			          },
			          {
			            "matcher": {
			              "id": "byName",
			              "options": "display"
			            },
			            "properties": [
			              {
			                "id": "custom.hideFrom",
			                "value": {
			                  "viz": true,
			                  "legend": true,
			                  "tooltip": true
			                }
			              }
			            ]
			          },
			          {
			            "matcher": {
			              "id": "byName",
			              "options": "plan_type"
			            },
			            "properties": [
			              {
			                "id": "custom.hideFrom",
			                "value": {
			                  "viz": true,
			                  "legend": true,
			                  "tooltip": true
			                }
			              }
			            ]
			          }
			        ]
			      },
			      "options": {
			        "showHeader": true,
			        "cellHeight": "sm",
			        "sortBy": [
			          {
			            "displayName": "Quota (USD, 7d)",
			            "desc": true
			          }
			        ]
			      },
			      "transformations": [
			        {
			          "id": "joinByField",
			          "options": {
			            "byField": "account_id",
			            "mode": "inner"
			          }
			        },
			        {
			          "id": "organize",
			          "options": {
			            "excludeByName": {
			              "Time": true,
			              "Time 1": true,
			              "Time 2": true,
			              "account_id": true,
			              "display": true,
			              "display 1": true,
			              "display 2": true,
			              "plan_type": true,
			              "plan_type 1": true,
			              "plan_type 2": true
			            },
				            "renameByName": {
				              "Value": "Quota (USD, 7d)",
				              "Value #A": "Quota (USD, 7d)",
				              "Value 1": "Spend (USD, since reset)",
				              "Value #B": "Spend (USD, since reset)",
				              "Value 2": "Δpp (since reset)",
				              "Value #C": "Δpp (since reset)"
				            },
				            "indexByName": {
				              "account_display": 0,
				              "Quota (USD, 7d)": 1,
				              "Spend (USD, since reset)": 2,
				              "Δpp (since reset)": 3
				            }
				          }
				        }
				      ],
      "targets": [
        {
          "refId": "A",
          "instant": true,
          "format": "table",
      "expr": "max by (account_id, account_display) (label_join(((codex_lb_secondary_implied_quota_usd_7d{account_id=~\"$account\"} and on(account_id) (codex_lb_secondary_used_percent_delta_pp_7d{account_id=~\"$account\"} >= $secondary_quota_min_pp)) * on(account_id) group_left(display, plan_type) ((codex_lb_account_identity @ end()) or on(account_id) label_replace(label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\"), \"plan_type\", \"unknown\", \"account_id\", \"(.*)\"))), \"account_display\", \"::\", \"plan_type\", \"display\"))"
        },
        {
          "refId": "B",
          "instant": true,
          "format": "table",
          "expr": "max by (account_id) (codex_lb_proxy_account_cost_usd_7d{account_id=~\"$account\"})"
        },
        {
          "refId": "C",
          "instant": true,
          "format": "table",
          "expr": "max by (account_id) (codex_lb_secondary_used_percent_delta_pp_7d{account_id=~\"$account\"})"
        }
      ]
    },
    {
      "id": 27,
      "type": "row",
      "title": "Daily rollups (requires Prometheus running)",
      "gridPos": {
        "x": 0,
        "y": 81,
        "w": 24,
        "h": 1
      },
      "collapsed": false,
      "panels": []
    },
				    {
				      "id": 28,
				      "type": "timeseries",
				      "title": "Cost/day (USD, completed days + 7d avg)",
				      "description": "Daily bars are completed days (increase(...[1d]) evaluated at 1d steps). The rightmost bar is usually yesterday. Compare with the \"Cost yesterday (USD)\" stat.",
				      "gridPos": {
				        "x": 0,
				        "y": 82,
				        "w": 12,
			        "h": 7
			      },
			      "hideTimeOverride": true,
			      "timeFrom": "now-30d/d",
				      "timeTo": "now/d",
			      "fieldConfig": {
		        "defaults": {
		          "custom": {
		            "drawStyle": "bars",
		            "barAlignment": 0,
		            "spanNulls": false,
		            "fillOpacity": 80,
		            "showPoints": "never"
		          }
		        },
		        "overrides": [
		          {
		            "matcher": {
		              "id": "byFrameRefID",
		              "options": "B"
		            },
		            "properties": [
		              {
		                "id": "custom.drawStyle",
		                "value": "line"
		              },
		              {
		                "id": "custom.fillOpacity",
		                "value": 0
		              },
		              {
		                "id": "custom.lineWidth",
		                "value": 2
		              }
		            ]
		          }
		        ]
		      },
		      "targets": [
		        {
		          "refId": "A",
			          "expr": "sum(increase(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[1d]))",
		          "interval": "1d",
		          "legendFormat": "daily"
		        },
		        {
		          "refId": "B",
			          "expr": "avg_over_time((sum(increase(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[1d])))[7d:1d])",
		          "interval": "1d",
		          "legendFormat": "7d avg"
		        }
		      ]
		    },
		    {
		      "id": 29,
		      "type": "table",
				      "title": "Cost yesterday (USD, top $accounts_top_n accounts)",
			      "description": "Top $accounts_top_n accounts by cost for the last completed day (yesterday, browser TZ). Account text is colored by plan type; the value bar is value-colored.",
		      "gridPos": {
		        "x": 12,
		        "y": 82,
		        "w": 12,
		        "h": 14
		      },
	      "hideTimeOverride": true,
	      "timeFrom": "now-2d/d",
	      "timeTo": "now/d",
	      "fieldConfig": {
	        "defaults": {
	          "color": {
	            "mode": "thresholds"
	          },
	          "custom": {
	            "align": "auto",
	            "cellOptions": {
	              "type": "auto"
	            },
	            "inspect": false
	          },
	          "mappings": [],
	          "thresholds": {
	            "mode": "absolute",
	            "steps": [
	              {
	                "color": "green",
	                "value": null
	              },
	              {
	                "color": "red",
	                "value": 1
	              }
	            ]
	          }
	        },
	        "overrides": [
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Account"
	            },
	            "properties": [
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "color-text"
	                }
	              },
	              {
	                "id": "mappings",
	                "value": [
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^free::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^plus::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#1d4ed8"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^pro::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#6d28d9"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^unknown::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#a1a1aa"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^[^:]+::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  }
	                ]
	              }
	            ]
	          },
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Cost yesterday (USD)"
	            },
	            "properties": [
	              {
	                "id": "unit",
	                "value": "currencyUSD"
	              },
	              {
	                "id": "decimals",
	                "value": 2
	              },
	              {
	                "id": "color",
	                "value": {
	                  "mode": "continuous-GrYlRd"
	                }
	              },
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "gauge",
	                  "mode": "gradient"
	                }
	              }
	            ]
		          }
		        ]
		      },
	      "options": {
	        "showHeader": true,
	        "cellHeight": "sm",
	        "sortBy": [
	          {
	            "displayName": "Cost yesterday (USD)",
	            "desc": true
	          }
	        ]
	      },
	      "transformations": [
	        {
	          "id": "labelsToFields",
	          "options": {}
	        },
	        {
	          "id": "organize",
	          "options": {
	            "excludeByName": {
	              "Time": true,
	              "account_id": true
	            },
	            "renameByName": {
	              "account_display": "Account",
	              "Value": "Cost yesterday (USD)"
	            },
	            "indexByName": {
	              "Account": 0,
	              "Cost yesterday (USD)": 1
	            }
	          }
	        }
	      ],
	      "targets": [
			        {
			          "refId": "A",
			          "instant": true,
		          "format": "table",
				          "expr": "max by (account_id, account_display) (label_join((topk($accounts_top_n, sum by (account_id) (increase(codex_lb_proxy_account_cost_usd_total{account_id=~\"$account\",api=~\"$api\"}[1d]))) * on(account_id) group_left(display, plan_type) (0 * (codex_lb_account_identity or on(account_id) label_replace(label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\"), \"plan_type\", \"unknown\", \"account_id\", \"(.*)\")) + 1)), \"account_display\", \"::\", \"plan_type\", \"display\"))"
			        }
	      ]
	    },
			    {
			      "id": 30,
			      "type": "timeseries",
			      "title": "Requests/day (total + 7d avg)",
			      "gridPos": {
			        "x": 0,
			        "y": 89,
			        "w": 12,
			        "h": 7
			      },
			      "hideTimeOverride": true,
			      "timeFrom": "now-30d/d",
			      "timeTo": "now/d",
			      "fieldConfig": {
		        "defaults": {
		          "custom": {
		            "drawStyle": "bars",
		            "barAlignment": 0,
		            "spanNulls": false,
		            "fillOpacity": 80,
		            "showPoints": "never"
		          }
		        },
		        "overrides": [
		          {
		            "matcher": {
		              "id": "byFrameRefID",
		              "options": "B"
		            },
		            "properties": [
		              {
		                "id": "custom.drawStyle",
		                "value": "line"
		              },
		              {
		                "id": "custom.fillOpacity",
		                "value": 0
		              },
		              {
		                "id": "custom.lineWidth",
		                "value": 2
		              }
		            ]
		          }
		        ]
		      },
		      "targets": [
		        {
		          "refId": "A",
			          "expr": "sum(increase(codex_lb_proxy_requests_total{model=~\"$model\",api=~\"$api\"}[1d]))",
		          "interval": "1d",
		          "legendFormat": "daily"
		        },
		        {
		          "refId": "B",
			          "expr": "avg_over_time((sum(increase(codex_lb_proxy_requests_total{model=~\"$model\",api=~\"$api\"}[1d])))[7d:1d])",
		          "interval": "1d",
		          "legendFormat": "7d avg"
		        }
		      ]
		    },
		    {
		      "id": 31,
		      "type": "table",
				      "title": "Requests yesterday (top $accounts_top_n accounts)",
			      "description": "Top $accounts_top_n accounts by requests for the last completed day (yesterday, browser TZ). Account text is colored by plan type; the value bar is value-colored.",
		      "gridPos": {
		        "x": 12,
		        "y": 96,
		        "w": 12,
		        "h": 14
		      },
	      "hideTimeOverride": true,
	      "timeFrom": "now-2d/d",
	      "timeTo": "now/d",
	      "fieldConfig": {
	        "defaults": {
	          "color": {
	            "mode": "thresholds"
	          },
	          "custom": {
	            "align": "auto",
	            "cellOptions": {
	              "type": "auto"
	            },
	            "inspect": false
	          },
	          "mappings": [],
	          "thresholds": {
	            "mode": "absolute",
	            "steps": [
	              {
	                "color": "green",
	                "value": null
	              },
	              {
	                "color": "red",
	                "value": 1
	              }
	            ]
	          }
	        },
	        "overrides": [
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Account"
	            },
	            "properties": [
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "color-text"
	                }
	              },
	              {
	                "id": "mappings",
	                "value": [
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^free::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^plus::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#1d4ed8"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^pro::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#6d28d9"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^unknown::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#a1a1aa"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^[^:]+::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  }
	                ]
	              }
	            ]
	          },
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Requests yesterday"
	            },
	            "properties": [
	              {
	                "id": "unit",
	                "value": "short"
	              },
	              {
	                "id": "decimals",
	                "value": 0
	              },
	              {
	                "id": "color",
	                "value": {
	                  "mode": "continuous-GrYlRd"
	                }
	              },
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "gauge",
	                  "mode": "gradient"
	                }
	              }
	            ]
	          }
	        ]
	      },
	      "options": {
	        "showHeader": true,
	        "cellHeight": "sm",
	        "sortBy": [
	          {
	            "displayName": "Requests yesterday",
	            "desc": true
	          }
	        ]
	      },
	      "transformations": [
	        {
	          "id": "labelsToFields",
	          "options": {}
	        },
	        {
	          "id": "organize",
	          "options": {
	            "excludeByName": {
	              "Time": true,
	              "account_id": true
	            },
	            "renameByName": {
	              "account_display": "Account",
	              "Value": "Requests yesterday"
	            },
	            "indexByName": {
	              "Account": 0,
	              "Requests yesterday": 1
	            }
	          }
	        }
	      ],
	      "targets": [
			        {
			          "refId": "A",
			          "instant": true,
		          "format": "table",
				          "expr": "max by (account_id, account_display) (label_join((topk($accounts_top_n, sum by (account_id) (increase(codex_lb_proxy_account_requests_total{account_id=~\"$account\",api=~\"$api\"}[1d]))) * on(account_id) group_left(display, plan_type) (0 * (codex_lb_account_identity or on(account_id) label_replace(label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\"), \"plan_type\", \"unknown\", \"account_id\", \"(.*)\")) + 1)), \"account_display\", \"::\", \"plan_type\", \"display\"))"
			        }
	      ]
	    },
		    {
		      "id": 39,
		      "type": "table",
			      "title": "Cost (USD, 30d total, top $accounts_top_n accounts)",
			      "description": "Top $accounts_top_n accounts by total cost over the last 30 completed days. Account text is colored by plan type; the value bar is value-colored.",
		      "gridPos": {
		        "x": 0,
		        "y": 110,
		        "w": 12,
		        "h": 14
		      },
	      "hideTimeOverride": true,
	      "timeFrom": "now-30d/d",
	      "timeTo": "now/d",
	      "fieldConfig": {
	        "defaults": {
	          "color": {
	            "mode": "thresholds"
	          },
	          "custom": {
	            "align": "auto",
	            "cellOptions": {
	              "type": "auto"
	            },
	            "inspect": false
	          },
	          "mappings": [],
	          "thresholds": {
	            "mode": "absolute",
	            "steps": [
	              {
	                "color": "green",
	                "value": null
	              },
	              {
	                "color": "red",
	                "value": 1
	              }
	            ]
	          }
	        },
	        "overrides": [
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Account"
	            },
	            "properties": [
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "color-text"
	                }
	              },
	              {
	                "id": "mappings",
	                "value": [
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^free::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^plus::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#1d4ed8"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^pro::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#6d28d9"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^unknown::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#a1a1aa"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^[^:]+::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  }
	                ]
	              }
	            ]
	          },
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Cost (USD, 30d total)"
	            },
	            "properties": [
	              {
	                "id": "unit",
	                "value": "currencyUSD"
	              },
	              {
	                "id": "decimals",
	                "value": 2
	              },
	              {
	                "id": "color",
	                "value": {
	                  "mode": "continuous-GrYlRd"
	                }
	              },
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "gauge",
	                  "mode": "gradient"
	                }
	              }
	            ]
	          }
	        ]
	      },
	      "options": {
	        "showHeader": true,
	        "cellHeight": "sm",
	        "sortBy": [
	          {
	            "displayName": "Cost (USD, 30d total)",
	            "desc": true
	          }
	        ]
	      },
	      "transformations": [
	        {
	          "id": "labelsToFields",
	          "options": {}
	        },
	        {
	          "id": "organize",
	          "options": {
	            "excludeByName": {
	              "Time": true,
	              "account_id": true
	            },
	            "renameByName": {
	              "account_display": "Account",
	              "Value": "Cost (USD, 30d total)"
	            },
	            "indexByName": {
	              "Account": 0,
	              "Cost (USD, 30d total)": 1
	            }
	          }
	        }
	      ],
	      "targets": [
	        {
	          "refId": "A",
	          "instant": true,
	          "format": "table",
	          "expr": "max by (account_id, account_display) (label_join((topk($accounts_top_n, sum by (account_id) (increase(codex_lb_proxy_account_cost_usd_total{account_id=~\"$account\",api=~\"$api\"}[30d]))) * on(account_id) group_left(display, plan_type) (0 * (codex_lb_account_identity or on(account_id) label_replace(label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\"), \"plan_type\", \"unknown\", \"account_id\", \"(.*)\")) + 1)), \"account_display\", \"::\", \"plan_type\", \"display\"))"
	        }
	      ]
	    },
		    {
		      "id": 40,
		      "type": "table",
			      "title": "Requests (30d total, top $accounts_top_n accounts)",
			      "description": "Top $accounts_top_n accounts by total requests over the last 30 completed days. Account text is colored by plan type; the value bar is value-colored.",
		      "gridPos": {
		        "x": 12,
		        "y": 110,
		        "w": 12,
		        "h": 14
		      },
	      "hideTimeOverride": true,
	      "timeFrom": "now-30d/d",
	      "timeTo": "now/d",
	      "fieldConfig": {
	        "defaults": {
	          "color": {
	            "mode": "thresholds"
	          },
	          "custom": {
	            "align": "auto",
	            "cellOptions": {
	              "type": "auto"
	            },
	            "inspect": false
	          },
	          "mappings": [],
	          "thresholds": {
	            "mode": "absolute",
	            "steps": [
	              {
	                "color": "green",
	                "value": null
	              },
	              {
	                "color": "red",
	                "value": 1
	              }
	            ]
	          }
	        },
	        "overrides": [
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Account"
	            },
	            "properties": [
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "color-text"
	                }
	              },
	              {
	                "id": "mappings",
	                "value": [
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^free::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^plus::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#1d4ed8"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^pro::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#6d28d9"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^unknown::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#a1a1aa"
	                      }
	                    }
	                  },
	                  {
	                    "type": "regex",
	                    "options": {
	                      "pattern": "^[^:]+::(.*)$",
	                      "result": {
	                        "text": "$1",
	                        "color": "#71717a"
	                      }
	                    }
	                  }
	                ]
	              }
	            ]
	          },
	          {
	            "matcher": {
	              "id": "byName",
	              "options": "Requests (30d total)"
	            },
	            "properties": [
	              {
	                "id": "unit",
	                "value": "short"
	              },
	              {
	                "id": "decimals",
	                "value": 0
	              },
	              {
	                "id": "color",
	                "value": {
	                  "mode": "continuous-GrYlRd"
	                }
	              },
	              {
	                "id": "custom.cellOptions",
	                "value": {
	                  "type": "gauge",
	                  "mode": "gradient"
	                }
	              }
	            ]
	          }
	        ]
	      },
	      "options": {
	        "showHeader": true,
	        "cellHeight": "sm",
	        "sortBy": [
	          {
	            "displayName": "Requests (30d total)",
	            "desc": true
	          }
	        ]
	      },
	      "transformations": [
	        {
	          "id": "labelsToFields",
	          "options": {}
	        },
	        {
	          "id": "organize",
	          "options": {
	            "excludeByName": {
	              "Time": true,
	              "account_id": true
	            },
	            "renameByName": {
	              "account_display": "Account",
	              "Value": "Requests (30d total)"
	            },
	            "indexByName": {
	              "Account": 0,
	              "Requests (30d total)": 1
	            }
	          }
	        }
	      ],
	      "targets": [
	        {
	          "refId": "A",
	          "instant": true,
	          "format": "table",
	          "expr": "max by (account_id, account_display) (label_join((topk($accounts_top_n, sum by (account_id) (increase(codex_lb_proxy_account_requests_total{account_id=~\"$account\",api=~\"$api\"}[30d]))) * on(account_id) group_left(display, plan_type) (0 * (codex_lb_account_identity or on(account_id) label_replace(label_replace(count by (account_id) (codex_lb_secondary_used_percent), \"display\", \"$1\", \"account_id\", \"(.*)\"), \"plan_type\", \"unknown\", \"account_id\", \"(.*)\")) + 1)), \"account_display\", \"::\", \"plan_type\", \"display\"))"
	        }
	      ]
	    },
      {
        "id": 32,
        "type": "row",
        "title": "Today (since 00:00, browser TZ)",
        "gridPos": {
          "x": 0,
          "y": 124,
          "w": 24,
		        "h": 1
		      },
      "collapsed": false,
      "panels": []
    },
      {
        "id": 33,
        "type": "stat",
        "title": "Cost — today so far",
        "description": "Since 00:00 (browser timezone).",
	        "gridPos": {
	          "x": 0,
	          "y": 125,
	          "w": 12,
	          "h": 4
	        },
        "options": {
          "colorMode": "value",
          "graphMode": "none",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "calcs": [
              "lastNotNull"
            ],
            "fields": "",
            "values": false
          },
          "showPercentChange": false,
          "textMode": "value",
          "wideLayout": false
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "green",
                  "value": null
                }
              ]
            }
          },
          "overrides": [
            {
              "matcher": {
                "id": "byName",
                "options": "Cost"
              },
              "properties": [
                {
                  "id": "unit",
                  "value": "currencyUSD"
                },
		              {
		                "id": "decimals",
		                "value": 2
		              },
		              {
                  "id": "color",
                  "value": {
                    "mode": "fixed",
                    "fixedColor": "#1d4ed8"
                  }
                }
              ]
            }
          ]
        },
        "hideTimeOverride": true,
        "timeFrom": "now/d",
        "targets": [
          {
            "refId": "A",
            "instant": true,
            "expr": "sum(increase(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[$__range]))",
            "legendFormat": "Cost"
          }
        ]
      },
	      {
	        "id": 42,
	        "type": "stat",
	        "title": "Projected EOD cost (run-rate)",
	        "description": "Run-rate estimate: cost-so-far × 86400 ÷ seconds-since-midnight.",
	        "gridPos": {
	          "x": 12,
	          "y": 125,
	          "w": 12,
	          "h": 4
	        },
        "options": {
          "colorMode": "value",
          "graphMode": "none",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "calcs": [
              "lastNotNull"
            ],
            "fields": "",
            "values": false
          },
          "showPercentChange": false,
          "textMode": "value",
          "wideLayout": false
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "color": "green",
                  "value": null
                }
              ]
            },
            "unit": "currencyUSD",
            "decimals": 2,
            "color": {
              "mode": "fixed",
              "fixedColor": "#f59e0b"
            }
          },
          "overrides": []
        },
        "hideTimeOverride": true,
        "timeFrom": "now/d",
        "targets": [
          {
            "refId": "A",
            "instant": true,
            "expr": "sum(increase(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[$__range])) * 86400 / clamp_min(vector($__range_s), 60)",
            "legendFormat": "Projected EOD cost"
          }
        ]
      },
	      {
	        "id": 35,
	        "type": "timeseries",
	        "title": "Today: cost/hr + projected EOD cost",
	        "description": "Hourly buckets since midnight (browser timezone). Projected EOD cost is a run-rate estimate (rate × 86400) and can be noisy.",
	        "gridPos": {
	          "x": 0,
	          "y": 129,
	          "w": 24,
          "h": 7
        },
	      "hideTimeOverride": true,
	      "timeFrom": "now/d",
		      "fieldConfig": {
		        "defaults": {
		          "unit": "currencyUSD",
		          "custom": {
		            "drawStyle": "line",
		            "lineWidth": 2,
		            "fillOpacity": 10,
		            "showPoints": "never"
		          }
		        },
		        "overrides": [
		          {
		            "matcher": {
		              "id": "byName",
		              "options": "Cost (USD, 1h)"
		            },
		            "properties": [
		              {
		                "id": "decimals",
		                "value": 2
		              },
		              {
		                "id": "color",
		                "value": {
		                  "mode": "fixed",
		                  "fixedColor": "#1d4ed8"
		                }
		              },
		              {
		                "id": "custom.drawStyle",
		                "value": "bars"
		              },
		              {
		                "id": "custom.fillOpacity",
		                "value": 80
		              },
		              {
		                "id": "custom.lineWidth",
		                "value": 0
		              },
		              {
		                "id": "custom.barAlignment",
		                "value": 0
		              },
		              {
		                "id": "custom.axisPlacement",
		                "value": "left"
		              },
	              {
	                "id": "custom.axisLabel",
	                "value": "USD"
	              }
	            ]
		          },
		          {
		            "matcher": {
		              "id": "byName",
	              "options": "Projected EOD cost (USD)"
	            },
	            "properties": [
	              {
	                "id": "decimals",
	                "value": 2
	              },
	              {
	                "id": "color",
	                "value": {
	                  "mode": "fixed",
	                  "fixedColor": "#f59e0b"
	                }
	              },
	              {
	                "id": "custom.lineStyle",
	                "value": {
	                  "dash": [
	                    10,
	                    10
	                  ],
	                  "fill": "dash"
	                }
	              },
	              {
	                "id": "custom.axisPlacement",
	                "value": "left"
	              },
	              {
	                "id": "custom.axisLabel",
	                "value": "USD"
	              }
	            ]
	          }
	        ]
	      },
			      "targets": [
			        {
			          "refId": "A",
				          "expr": "sum(increase(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[1h]))",
			          "interval": "1h",
			          "legendFormat": "Cost (USD, 1h)"
			        },
			        {
			          "refId": "C",
			          "expr": "sum(rate(codex_lb_proxy_cost_usd_total{model=~\"$model\"}[$__rate_interval])) * 86400",
			          "legendFormat": "Projected EOD cost (USD)"
			        }
		      ]
		    }
  ]
}

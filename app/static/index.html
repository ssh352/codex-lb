<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>Codex LB</title>
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;32&quot; height=&quot;32&quot; fill=&quot;none&quot; viewBox=&quot;0 0 32 32&quot;%3E%3Cpath stroke=&quot;%23000&quot; stroke-linecap=&quot;round&quot; stroke-width=&quot;2.484&quot; d=&quot;M22.356 19.797H17.17M9.662 12.29l1.979 3.576a.511.511 0 0 1-.005.504l-1.974 3.409M30.758 16c0 8.15-6.607 14.758-14.758 14.758-8.15 0-14.758-6.607-14.758-14.758C1.242 7.85 7.85 1.242 16 1.242c8.15 0 14.758 6.608 14.758 14.758Z&quot;/%3E%3C/svg%3E"
    type="image/svg+xml">
  <link rel="stylesheet" href="/dashboard/index.css">
</head>

<body class="has-scrollbar" x-data="feApp" :data-theme="theme" x-init="init()" x-cloak>
  <div class="app-shell">
    <header class="main-header">
      <div class="header-content">
        <h1 class="app-logo">Codex Load Balancer</h1>
        <div class="header-actions">
          <button class="theme-toggle" @click="toggleTheme" aria-label="Toggle theme">
            <svg x-show="theme === 'dark'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="4" />
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="m4.93 4.93 1.41 1.41" />
              <path d="m17.66 17.66 1.41 1.41" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="m6.34 17.66-1.41 1.41" />
              <path d="m19.07 4.93-1.41 1.41" />
            </svg>
            <svg x-show="theme === 'light'" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
            </svg>
          </button>
        </div>
      </div>
    </header>
    <main class="main-content">
      <div class="loading-overlay" x-show="isLoading" x-transition.opacity>
        <div class="loading-panel" role="status" aria-live="polite">
          <span class="spinner animate" aria-hidden="true"></span>
          <div>Loading Dashboard...</div>
        </div>
      </div>
      <section class="tabs" aria-label="Codex FE tabs">
        <menu role="tablist" aria-label="Codex FE tabs">
          <template x-for="page in pages" :key="page.id">
            <button role="tab" type="button" :aria-controls="page.tabId" :aria-selected="view === page.id"
              :tabindex="view === page.id ? 0 : -1" @click="setView(page.id)" @focus="setView(page.id)">
              <span x-text="page.label"></span>
            </button>
          </template>
        </menu>

        <article role="tabpanel" id="tab-dashboard" :hidden="view !== 'dashboard'">
          <div class="hero-banner">
            <h2>Quota remaining and routing health</h2>
            <p>Live summary of remaining quota for Codex traffic routed through the ChatGPT-style backend. Account
              status and load
              balancing signals are surfaced here.</p>
            <div class="badge-row">
              <template x-for="badge in dashboard.badges" :key="badge.label">
                <span class="status-pill" :class="badge.status" x-text="badge.label"></span>
              </template>
            </div>
          </div>

          <div class="section-grid" style="margin-top: 12px">
            <template x-for="stat in dashboard.stats" :key="stat.title">
              <div class="panel">
                <h3 x-text="stat.title"></h3>
                <div class="stat-value" x-text="stat.value"></div>
                <div class="stat-meta" x-text="stat.meta"></div>
              </div>
            </template>
          </div>

          <div class="two-column two-column--equal" style="margin-top: 12px">
            <template x-for="donut in dashboard.donuts" :key="donut.title">
              <div class="panel">
                <h3 x-text="donut.title"></h3>
                <div class="donut-wrap">
                  <div class="donut" :style="{ '--donut-data': donut.gradient }">
                    <div class="donut-center">
                      <strong x-text="donut.range"></strong>
                      <div x-text="donut.total"></div>
                    </div>
                  </div>
                  <ul class="legend">
                    <template x-for="item in donut.items" :key="item.label">
                      <li>
                        <span class="legend-label">
                          <i :style="{ '--legend-color': item.color }"></i>
                          <span class="legend-label-text" x-text="item.label" :title="item.fullLabel"></span>
                        </span>
                        <span class="legend-detail">
                          <span class="legend-detail-label" x-text="item.detailLabel"></span>
                          <span class="legend-detail-value" :class="item.valueClass" x-text="item.detailValue"></span>
                        </span>
                      </li>
                    </template>
                  </ul>
                </div>
              </div>
            </template>
          </div>

          <section style="margin-top: 12px">
            <h3>Account status</h3>
            <div class="account-grid">
              <template x-for="card in dashboard.accountCards" :key="card.email">
                <div class="account-card">
                  <header>
                    <div>
                      <div x-text="`${card.email} (${card.plan})`" :title="`${card.email} (${card.plan})`"></div>
                      <div class="account-id" x-text="card.accountId"></div>
                    </div>
                    <span class="status-pill" :class="card.status.class" x-text="card.status.label"></span>
                  </header>
                  <div class="progress-row">
                    <label
                      x-text="`Remaining (${formatWindowLabel('secondary', dashboardData.usage.secondary.windowMinutes)})`"></label>
                    <template x-if="card.marquee">
                      <div role="progressbar" class="marquee"></div>
                    </template>
                    <template x-if="!card.marquee">
                      <div role="progressbar" :class="card.progressClass" aria-valuemin="0" aria-valuemax="100"
                        :aria-valuenow="card.remaining">
                        <div :style="{ width: `${card.remaining}%` }"></div>
                      </div>
                    </template>
                    <span class="text-muted" x-text="card.remainingText"></span>
                  </div>
                  <div class="text-muted" x-text="card.meta"></div>
                  <div class="account-actions">
                    <template x-for="action in card.actions" :key="action.label">
                      <button x-text="action.label" @click="handleAccountAction(action, card)"></button>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </section>

          <div class="panel" style="margin-top: 12px">
            <h3>Recent requests</h3>

            <div class="controls-toolbar">
              <div class="controls-group">
                <input type="text" class="filter-input" placeholder="Search..." x-model="filtersDraft.search"
                  @keyup.enter="applyFilters()" style="width: 200px;">

                <div class="single-select" x-data="{ open: false }" @click.outside="open = false">
                  <button type="button" class="filter-select single-select-trigger" @click="open = !open"
                    :aria-expanded="open">
                    <span x-text="timeframeLabel(filtersDraft.timeframe)"></span>
                  </button>
                  <div class="single-select-menu" x-show="open" x-transition.opacity>
                    <label class="single-select-item" :class="{ 'is-selected': filtersDraft.timeframe === 'all' }">
                      <input type="radio" name="timeframe" value="all" x-model="filtersDraft.timeframe"
                        @change="open = false">
                      <span>All time</span>
                    </label>
                    <label class="single-select-item" :class="{ 'is-selected': filtersDraft.timeframe === '1h' }">
                      <input type="radio" name="timeframe" value="1h" x-model="filtersDraft.timeframe"
                        @change="open = false">
                      <span>Last 1h</span>
                    </label>
                    <label class="single-select-item" :class="{ 'is-selected': filtersDraft.timeframe === '24h' }">
                      <input type="radio" name="timeframe" value="24h" x-model="filtersDraft.timeframe"
                        @change="open = false">
                      <span>Last 24h</span>
                    </label>
                    <label class="single-select-item" :class="{ 'is-selected': filtersDraft.timeframe === '7d' }">
                      <input type="radio" name="timeframe" value="7d" x-model="filtersDraft.timeframe"
                        @change="open = false">
                      <span>Last 7d</span>
                    </label>
                  </div>
                </div>


                <div class="multi-select" x-data="{ open: false }" @click.outside="open = false">
                  <button type="button" class="filter-select multi-select-trigger"
                    @click="ensureRequestLogOptions(); open = !open"
                    :aria-expanded="open" :disabled="requestLogOptions.isLoading">
                    <span
                      x-text="multiSelectSummary(filtersDraft.accountIds, 'All accounts', 'account', 'accounts')"></span>
                  </button>
                  <div class="multi-select-menu" x-show="open" x-transition.opacity>
                    <div class="multi-select-scroller">
                      <div class="multi-select-actions">
                        <button type="button" class="multi-select-action"
                          @click="filtersDraft.accountIds = []; open = false">Clear</button>
                      </div>
                      <template x-for="accountId in requestLogOptions.accountIds" :key="accountId">
                        <label class="multi-select-item">
                          <input type="checkbox" :checked="filtersDraft.accountIds.includes(accountId)"
                            @change="toggleMultiSelectValue('accountIds', accountId)">
                          <span class="multi-select-label" x-text="accountFilterLabel(accountId)"></span>
                        </label>
                      </template>
                    </div>
                  </div>
                </div>

                <div class="multi-select" x-data="{ open: false }" @click.outside="open = false">
                  <button type="button" class="filter-select multi-select-trigger"
                    @click="ensureRequestLogOptions(); open = !open"
                    :aria-expanded="open" :disabled="requestLogOptions.isLoading">
                    <span
                      x-text="multiSelectSummary(filtersDraft.modelOptions, 'All models', 'model', 'models')"></span>
                  </button>
                  <div class="multi-select-menu" x-show="open" x-transition.opacity>
                    <div class="multi-select-scroller">
                      <div class="multi-select-actions">
                        <button type="button" class="multi-select-action"
                          @click="filtersDraft.modelOptions = []; open = false">Clear</button>
                      </div>
                      <template x-for="modelOption in requestLogOptions.modelOptions"
                        :key="modelOptionValue(modelOption)">
                        <label class="multi-select-item">
                          <input type="checkbox"
                            :checked="filtersDraft.modelOptions.includes(modelOptionValue(modelOption))"
                            @change="toggleMultiSelectValue('modelOptions', modelOptionValue(modelOption))">
                          <span class="multi-select-label" x-text="modelOptionLabel(modelOption)"></span>
                        </label>
                      </template>
                    </div>
                  </div>
                </div>

                <div class="multi-select" x-data="{ open: false }" @click.outside="open = false">
                  <button type="button" class="filter-select multi-select-trigger" @click="open = !open"
                    :aria-expanded="open">
                    <span x-text="multiSelectSummary(filtersDraft.statuses, 'All status', 'status', 'statuses')"></span>
                  </button>
                  <div class="multi-select-menu" x-show="open" x-transition.opacity>
                    <div class="multi-select-scroller">
                      <div class="multi-select-actions">
                        <button type="button" class="multi-select-action"
                          @click="filtersDraft.statuses = []; open = false">Clear</button>
                      </div>
                      <label class="multi-select-item">
                        <input type="checkbox" :checked="filtersDraft.statuses.includes('ok')"
                          @change="toggleMultiSelectValue('statuses', 'ok')">
                        <span class="multi-select-label">OK</span>
                      </label>
                      <label class="multi-select-item">
                        <input type="checkbox" :checked="filtersDraft.statuses.includes('rate_limit')"
                          @change="toggleMultiSelectValue('statuses', 'rate_limit')">
                        <span class="multi-select-label">Rate Limit</span>
                      </label>
                      <label class="multi-select-item">
                        <input type="checkbox" :checked="filtersDraft.statuses.includes('quota')"
                          @change="toggleMultiSelectValue('statuses', 'quota')">
                        <span class="multi-select-label">Quota</span>
                      </label>
                      <label class="multi-select-item">
                        <input type="checkbox" :checked="filtersDraft.statuses.includes('error')"
                          @change="toggleMultiSelectValue('statuses', 'error')">
                        <span class="multi-select-label">Error</span>
                      </label>
                    </div>
                  </div>
                </div>

                <input type="number" class="filter-input" placeholder="Min Cost ($)" x-model="filtersDraft.minCost"
                  @keyup.enter="applyFilters()" style="width: 110px;" step="0.01">

                <button type="button" class="filter-apply" @click="applyFilters()"
                  :disabled="recentRequestsState.isLoading">Apply</button>
              </div>

              <div class="controls-group">
                <span style="font-size: 13px; color: var(--text-muted);">Show:</span>
                <div class="single-select" x-data="{ open: false }" @click.outside="open = false">
                  <button type="button" class="filter-select single-select-trigger" @click="open = !open"
                    :aria-expanded="open" style="min-width: 60px">
                    <span x-text="pagination.limit"></span>
                  </button>
                  <div class="single-select-menu" x-show="open" x-transition.opacity style="min-width: 80px">
                    <label class="single-select-item" :class="{ 'is-selected': pagination.limit == 25 }">
                      <input type="radio" name="limit" value="25" x-model="pagination.limit" @change="open = false">
                      <span>25</span>
                    </label>
                    <label class="single-select-item" :class="{ 'is-selected': pagination.limit == 50 }">
                      <input type="radio" name="limit" value="50" x-model="pagination.limit" @change="open = false">
                      <span>50</span>
                    </label>
                    <label class="single-select-item" :class="{ 'is-selected': pagination.limit == 100 }">
                      <input type="radio" name="limit" value="100" x-model="pagination.limit" @change="open = false">
                      <span>100</span>
                    </label>
                    <label class="single-select-item" :class="{ 'is-selected': pagination.limit == 250 }">
                      <input type="radio" name="limit" value="250" x-model="pagination.limit" @change="open = false">
                      <span>250</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <div class="table-wrap table-wrap--requests table-wrap--column-lines has-scrollbar">
              <table>
                <thead>
                  <tr>
                    <th class="highlighted indicator" style="width: 15%">Time</th>
                    <th style="width: 25%">Account</th>
                    <th style="width: 15%">Model</th>
                    <th style="width: 10%">Status</th>
                    <th style="width: 15%">Error</th>
                    <th style="width: 10%">Tokens</th>
                    <th style="width: 10%">Cost</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="request in dashboard.requests" :key="request.key">
                    <tr>
                      <td>
                        <div x-text="request.time.time"></div>
                        <div x-text="request.time.date" class="text-muted" style="font-size: 11px;"></div>
                      </td>
                      <td class="cell-truncate" x-text="request.account" :title="request.account"></td>
                      <td class="cell-truncate" x-text="request.model" :title="request.model"></td>
                      <td><span class="status-pill" :class="request.status.class" x-text="request.status.label"></span>
                      </td>
                      <td class="cell-error">
                        <div class="error-cell" :class="request.isErrorPlaceholder ? 'placeholder' : ''"
                          x-data="{ expanded: false }">
                          <div class="error-text" :class="!expanded ? 'truncated' : ''"
                            x-text="expanded ? request.errorTitle : request.error"
                            :title="!expanded ? request.errorTitle : ''"></div>
                          <template x-if="request.isTruncated">
                            <button class="error-toggle" @click="expanded = !expanded"
                              x-text="expanded ? 'Less' : 'More'"></button>
                          </template>
                        </div>
                      </td>
                      <td>
                        <div x-text="request.tokens.total"></div>
                        <template x-if="request.tokens.cached">
                          <div x-text="`${request.tokens.cached} Cached`" class="text-muted" style="font-size: 11px;">
                          </div>
                        </template>
                      </td>
                      <td x-text="request.cost"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </article>

        <article role="tabpanel" id="tab-accounts" :hidden="view !== 'accounts'">
          <div class="two-column">
            <div class="panel account-list-panel">
              <h3>Account list</h3>
              <div class="list-actions">
                <div class="searchbox">
                  <input type="search" placeholder="Search accounts" aria-label="Search accounts" x-ref="accountSearch"
                    x-model="accounts.searchQuery" @keydown.escape.prevent="clearAccountSearch">
                  <button type="button" aria-label="search" title="Search accounts"
                    @click="focusAccountSearch"></button>
                </div>
                <label role="button" :class="{ 'is-disabled': importState.isLoading }" @click="logImportClick('label')">
                  <input type="file" class="file-input" accept="application/json" @click="logImportClick('input')"
                    @change="handleAuthImport($event)" :disabled="importState.isLoading">
                  Import auth.json
                </label>
                <button type="button" @click="openAddAccountDialog">Add account</button>
              </div>
              <div class="table-wrap table-wrap--column-lines has-scrollbar">
                <table>
                  <thead>
                    <tr>
                      <th class="highlighted indicator" style="width: 28%">Account ID</th>
                      <th style="width: 25%">Email</th>
                      <th style="width: 10%">Plan</th>
                      <th style="width: 12%">Status</th>
                      <th style="text-align: center; width: 12%">
                        <span style="display: inline-flex; flex-direction: column; align-items: center">
                          <span>Remaining</span>
                          <span style="font-weight: normal; font-size: 0.9em; color: var(--text-muted)"
                            x-text="`(${formatWindowLabel('secondary', dashboardData.usage.secondary.windowMinutes)})`">
                          </span>
                        </span>
                      </th>
                      <th style="text-align: center; width: 13%">
                        <span style="display: inline-flex; flex-direction: column; align-items: center">
                          <span style="white-space: nowrap">Quota reset</span>
                          <span style="font-weight: normal; font-size: 0.9em; color: var(--text-muted)"
                            x-text="`(${formatWindowLabel('secondary', dashboardData.usage.secondary.windowMinutes)})`">
                          </span>
                        </span>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="account in filteredAccounts" :key="account.id">
                      <tr :class="{ highlighted: account.id === accounts.selectedId }"
                        @click="selectAccount(account.id)" style="cursor: pointer">
                        <td class="cell-truncate" x-text="account.id" :title="account.id"></td>
                        <td class="cell-truncate" x-text="account.email" :title="account.email"></td>
                        <td x-text="planLabel(account.plan)"></td>
                        <td><span class="status-pill" :class="account.status"
                            x-text="statusLabel(account.status)"></span>
                        </td>
                        <td style="text-align: center"
                          :class="calculateTextUsageTextClass(account.status, account.usage?.secondaryRemainingPercent)"
                          x-text="formatPercent(account.usage?.secondaryRemainingPercent)">
                        </td>
                        <td style="text-align: center" x-text="formatQuotaResetLabel(account.resetAtSecondary)"></td>
                      </tr>
                    </template>
                    <template x-if="filteredAccounts.length === 0">
                      <tr>
                        <td colspan="6" class="text-muted" style="text-align: center">
                          <span
                            x-text="accounts.searchQuery ? 'No accounts match your search.' : 'No accounts available.'"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <h3>Selected account</h3>
              <div class="summary-list">
                <div><span>Email</span><strong x-text="selectedAccount.email" :title="selectedAccount.email"></strong>
                </div>
                <div><span>Account ID</span><strong x-text="selectedAccount.id" :title="selectedAccount.id"></strong>
                </div>
                <div><span>Plan</span><strong x-text="planLabel(selectedAccount.plan)"></strong></div>
                <div>
                  <span>Status</span>
                  <span class="status-pill" :class="selectedAccount.status"
                    x-text="statusLabel(selectedAccount.status)"></span>
                </div>
                <div><span
                    x-text="`Quota reset (${formatWindowLabel('primary', dashboardData.usage.primary.windowMinutes)})`"></span><strong
                    x-text="formatQuotaResetLabel(selectedAccount.resetAtPrimary)"></strong></div>
                <div><span
                    x-text="`Quota reset (${formatWindowLabel('secondary', dashboardData.usage.secondary.windowMinutes)})`"></span><strong
                    x-text="formatQuotaResetLabel(selectedAccount.resetAtSecondary)"></strong></div>
              </div>

              <div class="split-stack" style="margin-top: 12px">
                <div class="progress-row">
                  <label
                    x-text="`Remaining (${formatWindowLabel('primary', dashboardData.usage.primary.windowMinutes)})`"></label>
                  <div role="progressbar" aria-valuemin="0" aria-valuemax="100"
                    :class="calculateProgressClass(selectedAccount.status, selectedAccount.usage?.primaryRemainingPercent)"
                    :aria-valuenow="formatPercentValue(selectedAccount.usage?.primaryRemainingPercent)">
                    <div :style="{ width: `${formatPercentValue(selectedAccount.usage?.primaryRemainingPercent)}%` }">
                    </div>
                  </div>
                  <span
                    :class="calculateTextUsageTextClass(selectedAccount.status, selectedAccount.usage?.primaryRemainingPercent)"
                    x-text="formatPercent(selectedAccount.usage?.primaryRemainingPercent)"></span>
                </div>
                <div class="progress-row">
                  <label
                    x-text="`Remaining (${formatWindowLabel('secondary', dashboardData.usage.secondary.windowMinutes)})`"></label>
                  <div role="progressbar" aria-valuemin="0" aria-valuemax="100"
                    :class="calculateProgressClass(selectedAccount.status, selectedAccount.usage?.secondaryRemainingPercent)"
                    :aria-valuenow="formatPercentValue(selectedAccount.usage?.secondaryRemainingPercent)">
                    <div :style="{ width: `${formatPercentValue(selectedAccount.usage?.secondaryRemainingPercent)}%` }">
                    </div>
                  </div>
                  <span
                    :class="calculateTextUsageTextClass(selectedAccount.status, selectedAccount.usage?.secondaryRemainingPercent)"
                    x-text="formatPercent(selectedAccount.usage?.secondaryRemainingPercent)"></span>
                </div>
              </div>

              <fieldset class="token-fieldset">
                <legend>Tokens</legend>
                <div class="summary-list">
                  <div><span>Access token</span><span x-text="formatAccessTokenLabel(selectedAccount.auth)"></span>
                  </div>
                  <div><span>Refresh token</span><span x-text="formatRefreshTokenLabel(selectedAccount.auth)"></span>
                  </div>
                  <div><span>Id token</span><span x-text="formatIdTokenLabel(selectedAccount.auth)"></span></div>
                </div>
              </fieldset>

              <div class="inline-actions" style="margin-top: 12px">
                <template x-if="selectedAccount.status === 'deactivated'">
                  <button @click="startReauthFlow">Re-authenticate</button>
                </template>
                <template x-if="selectedAccount.status === 'paused'">
                  <button @click="resumeSelectedAccount">Resume</button>
                </template>
                <template x-if="selectedAccount.status !== 'deactivated' && selectedAccount.status !== 'paused'">
                  <button @click="pauseSelectedAccount">Pause</button>
                </template>
                <button @click="deleteSelectedAccount">Delete</button>
              </div>
            </div>
          </div>
        </article>

        <article role="tabpanel" id="tab-settings" :hidden="view !== 'settings'">
          <div class="panel">
            <h3>Routing settings</h3>
            <p class="text-muted">Toggle routing features. When both options are off, accounts are selected by
              balancing usage evenly.</p>

            <p class="text-muted" x-show="settings.isLoading" x-transition.opacity>Loading settingsâ€¦</p>

            <fieldset class="settings-fieldset" :disabled="settings.isLoading || settings.isSaving || !settings.hasLoaded">
              <legend>Sticky threads</legend>
              <input id="sticky-threads-toggle" type="checkbox" x-model="settings.stickyThreadsEnabled"
                aria-describedby="sticky-threads-help">
              <label for="sticky-threads-toggle">Enable sticky threads (reuse the same upstream account per
                conversation)</label>
              <div id="sticky-threads-help" class="text-muted" style="margin-top: 6px">
                When enabled, requests with a prompt cache key stay pinned to the same upstream account unless the
                pinned account becomes unavailable.
              </div>
            </fieldset>

            <fieldset class="settings-fieldset" :disabled="settings.isLoading || settings.isSaving || !settings.hasLoaded">
              <legend>Reset priority</legend>
              <input id="reset-priority-toggle" type="checkbox" x-model="settings.preferEarlierResetAccounts"
                aria-describedby="reset-priority-help">
              <label for="reset-priority-toggle">Prefer accounts that reset earlier first</label>
              <div id="reset-priority-help" class="text-muted" style="margin-top: 6px">
                When enabled, the load balancer prefers accounts whose secondary quota resets sooner, then balances
                usage.
              </div>
            </fieldset>

            <fieldset class="settings-fieldset">
              <legend>TOTP access control</legend>
              <input id="totp-required-toggle" type="checkbox" x-model="settings.totpRequiredOnLogin"
                :disabled="!settings.totpConfigured" aria-describedby="totp-required-help">
              <label for="totp-required-toggle">Require TOTP verification on every dashboard login</label>
              <div id="totp-required-help" class="text-muted" style="margin-top: 6px">
                Status: <strong x-text="settings.totpConfigured ? 'Configured' : 'Not configured'"></strong>. Configure
                TOTP first, then enable enforcement.
              </div>
              <div class="inline-actions" style="margin-top: 10px">
                <button type="button" @click="setupTotp" :disabled="settings.totpConfigured">Setup TOTP</button>
                <button type="button" @click="disableTotp" :disabled="!settings.totpConfigured">Disable TOTP</button>
              </div>

              <template x-if="settings.totpSetup.open">
                <div class="panel" style="margin-top: 12px; padding: 12px">
                  <h4 style="margin: 0 0 8px 0;">TOTP setup</h4>
                  <p class="text-muted" style="margin: 0 0 8px 0;">Scan QR in authenticator app, then enter current 6-digit code.</p>
                  <template x-if="settings.totpSetup.qrSvgDataUri">
                    <img :src="settings.totpSetup.qrSvgDataUri" alt="TOTP QR code"
                      style="width: 220px; height: 220px; display: block; margin-bottom: 8px; border: 1px solid var(--border-color); background: #fff;">
                  </template>
                  <div class="text-muted" style="margin-bottom: 6px;">
                    Secret: <code x-text="settings.totpSetup.secret"></code>
                  </div>
                  <div class="text-muted" style="margin-bottom: 8px;">
                    URI: <code x-text="settings.totpSetup.otpauthUri"></code>
                  </div>
                  <input type="text" inputmode="numeric" maxlength="6" placeholder="123456"
                    x-model="settings.totpSetup.code" style="width: 160px; margin-bottom: 8px;">
                  <div class="inline-actions">
                    <button type="button" class="default" @click="confirmTotpSetup"
                      :disabled="settings.totpSetup.isSubmitting">Confirm</button>
                    <button type="button" @click="cancelTotpSetup" :disabled="settings.totpSetup.isSubmitting">Cancel</button>
                  </div>
                </div>
              </template>
            </fieldset>

            <div class="inline-actions" style="margin-top: 12px">
              <button type="button" @click="saveSettings" :disabled="settings.isLoading || settings.isSaving || !settings.hasLoaded">
                <span>Save</span>
              </button>
            </div>
          </div>
        </article>
      </section>
  </div>
  <div class="status-bar">
    <template x-for="item in statusItems" :key="item">
      <p class="status-bar-field" x-text="item"></p>
    </template>
  </div>
  <div class="dialog-backdrop auth-dialog-backdrop" :class="{ 'is-open': authDialog.open }"
    :aria-hidden="!authDialog.open"></div>
  <div class="window active is-bright auth-dialog" role="dialog" aria-modal="true" aria-labelledby="add-account-title"
    :aria-hidden="!authDialog.open" :class="{ 'is-open': authDialog.open }">
    <div class="title-bar">
      <div class="title-bar-text" id="add-account-title">Add account</div>
      <div class="title-bar-controls">
        <button aria-label="Close" @click="closeAddAccountDialog"></button>
      </div>
    </div>
    <div class="window-body has-space auth-dialog__body">
      <template x-if="authDialog.stage === 'intro'">
        <div class="auth-dialog__intro">
          <p class="auth-dialog__lead">Sign in with ChatGPT OAuth. API keys are not supported.</p>
          <fieldset class="auth-dialog__methods">
            <legend>Sign-in method</legend>
            <div class="auth-dialog__option" @click="authDialog.selectedMethod = 'browser'">
              <input id="auth-method-browser" type="radio" name="auth-method" value="browser"
                x-model="authDialog.selectedMethod">
              <label for="auth-method-browser">Browser login (PKCE)</label>
              <div class="auth-dialog__option-meta text-muted">Requires local callback on port 1455.</div>
            </div>
            <div class="auth-dialog__option" @click="authDialog.selectedMethod = 'device'">
              <input id="auth-method-device" type="radio" name="auth-method" value="device"
                x-model="authDialog.selectedMethod">
              <label for="auth-method-device">Device code</label>
              <div class="auth-dialog__option-meta text-muted">Use when running in Docker or remote environments.
              </div>
            </div>
          </fieldset>
        </div>
      </template>
      <template x-if="authDialog.stage === 'browser'">
        <div class="auth-dialog__panel">
          <p class="auth-dialog__lead">Open the authorization page to complete sign-in.</p>
          <div class="auth-dialog__detail">
            <div class="auth-dialog__label">Authorization URL</div>
            <div class="url-copy-row">
              <a class="auth-dialog__value auth-dialog__link" :href="authDialog.authorizationUrl" target="_blank"
                x-text="authDialog.authorizationUrl"></a>
              <button type="button" class="copy-btn"
                @click="copyToClipboard(authDialog.authorizationUrl, 'Authorization URL', $event)">Copy</button>
            </div>
          </div>
          <div class="auth-dialog__status">
            <span class="auth-dialog__status-text" x-text="authDialog.statusLabel"></span>
            <span class="spinner animate" aria-hidden="true" x-show="authDialog.status === 'pending'"></span>
          </div>
        </div>
      </template>
      <template x-if="authDialog.stage === 'device'">
        <div class="auth-dialog__panel">
          <p class="auth-dialog__lead">Use the device code to sign in. Enter the code at the verification URL.</p>
          <ol class="auth-dialog__steps">
            <li>Open the verification URL.</li>
            <li>Enter the user code shown below.</li>
            <li>Return here to finish the sign-in.</li>
          </ol>
          <div class="auth-dialog__device-grid">
            <div>
              <div class="auth-dialog__label">User code</div>
              <div class="auth-dialog__code-value">
                <span x-text="authDialog.userCode"></span>
                <button type="button" class="copy-btn"
                  @click="copyToClipboard(authDialog.userCode, 'User code', $event)">Copy</button>
              </div>
            </div>
            <div>
              <div class="auth-dialog__label">Verification URL</div>
              <div class="url-copy-row">
                <a class="auth-dialog__value auth-dialog__link" :href="authDialog.verificationUrl" target="_blank"
                  x-text="authDialog.verificationUrl"></a>
                <button type="button" class="copy-btn"
                  @click="copyToClipboard(authDialog.verificationUrl, 'Verification URL', $event)">Copy</button>
              </div>
            </div>
          </div>
          <div class="auth-dialog__status">
            <span class="auth-dialog__status-text" x-text="authDialog.statusLabel"></span>
            <div class="auth-dialog__status-meta" x-show="authDialog.status === 'pending'">
              <span class="spinner animate" aria-hidden="true"></span>
              <span class="text-muted">Expires in <span
                  x-text="formatCountdown(authDialog.remainingSeconds)"></span></span>
            </div>
          </div>
        </div>
      </template>
      <template x-if="authDialog.stage === 'success'">
        <div class="auth-dialog__panel">
          <p class="auth-dialog__lead">Account linked successfully.</p>
          <p class="text-muted">Return to the dashboard and select the new account.</p>
        </div>
      </template>
      <template x-if="authDialog.stage === 'error'">
        <div class="auth-dialog__panel auth-dialog__error">
          <p class="auth-dialog__lead">Authorization failed.</p>
          <p class="text-muted" x-text="authDialog.errorMessage"></p>
        </div>
      </template>
    </div>
    <footer class="auth-dialog__actions">
      <div class="auth-dialog__actions-row" x-show="authDialog.stage === 'intro'">
        <button type="button" @click="closeAddAccountDialog">Cancel</button>
        <button type="button" class="default" @click="startOAuth" :disabled="authDialog.isLoading">Start sign-in
        </button>
      </div>
      <div class="auth-dialog__actions-row" x-show="authDialog.stage === 'browser'">
        <button type="button" @click="resetAuthDialogState">Change method</button>
        <button type="button" class="default" @click="openAuthorizationUrl"
          :disabled="!authDialog.authorizationUrl">Open sign-in page</button>
      </div>
      <div class="auth-dialog__actions-row" x-show="authDialog.stage === 'device'">
        <button type="button" @click="resetAuthDialogState">Change method</button>
        <button type="button" class="default" @click="openVerificationUrl" :disabled="!authDialog.verificationUrl">Open
          link</button>
      </div>
      <div class="auth-dialog__actions-row" x-show="authDialog.stage === 'success'">
        <button type="button" class="default" @click="closeAddAccountDialog">Done</button>
      </div>
      <div class="auth-dialog__actions-row" x-show="authDialog.stage === 'error'">
        <button type="button" @click="resetAuthDialogState">Try again</button>
        <button type="button" class="default" @click="closeAddAccountDialog">Close</button>
      </div>
    </footer>
  </div>
  <div class="dialog-backdrop" :class="{ 'is-open': messageBox.open }" :aria-hidden="!messageBox.open"
    @click="closeMessageBox"></div>
  <div class="window active is-bright message-dialog" role="dialog" aria-modal="true"
    aria-labelledby="message-box-title" aria-describedby="message-box-body" :aria-hidden="!messageBox.open"
    :class="{ 'is-open': messageBox.open }">
    <div class="title-bar">
      <div class="title-bar-text" id="message-box-title" x-text="messageBox.title"></div>
      <div class="title-bar-controls">
        <button aria-label="Close" @click="closeMessageBox"></button>
      </div>
    </div>
    <div class="window-body has-space message-dialog__body">
      <div class="message-dialog__content">
        <div class="message-dialog__icon" :class="messageBox.iconTone ? `is-${messageBox.iconTone}` : ''"
          aria-hidden="true" x-show="messageBox.iconTone"></div>
        <div class="message-dialog__copy">
          <p id="message-box-body" x-text="messageBox.message"></p>
          <template x-if="messageBox.details">
            <pre class="code-box message-dialog__details" x-text="messageBox.details"></pre>
          </template>
        </div>
      </div>
    </div>
    <footer class="message-dialog__actions">
      <button x-show="messageBox.mode === 'confirm'" type="button" @click="cancelMessageBox"
        x-text="messageBox.cancelLabel"></button>
      <button x-show="messageBox.mode === 'confirm'" type="button" class="default" @click="confirmMessageBox"
        x-text="messageBox.confirmLabel"></button>
      <button x-show="messageBox.mode !== 'confirm'" type="button" class="default" @click="closeMessageBox">OK</button>
    </footer>
  </div>
  </div>
  </main>
  </div>
  <script defer src="/dashboard/index.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.2/dist/cdn.min.js"></script>
</body>

</html>
